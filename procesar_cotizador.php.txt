<?php
// Establecer la cabecera para indicar que la respuesta es JSON
header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *'); // ¡OJO! Permite cualquier origen (para pruebas). En producción, reemplaza * con https://tudominio.com
header('Access-Control-Allow-Methods: POST, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type');

// Manejar solicitud OPTIONS (preflight de CORS)
if ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {
  exit;
}

// Asegurarse de que la solicitud sea POST
if ($_SERVER['REQUEST_METHOD'] != 'POST') {
  // Enviar error si no es POST
  http_response_code(405); // Method Not Allowed
  echo json_encode(['status' => 'error', 'message' => 'Método no permitido. Se requiere POST.']);
  exit;
}

// Leer el cuerpo de la solicitud JSON enviado por fetch
$jsonPayload = file_get_contents('php://input');
// Decodificar el JSON a un objeto PHP o array asociativo
$data = json_decode($jsonPayload); // Poner true como segundo argumento para obtener un array: json_decode($jsonPayload, true);

// Validar que los datos se recibieron y decodificaron correctamente
if (json_last_error() !== JSON_ERROR_NONE || !$data) {
    http_response_code(400); // Bad Request
    echo json_encode(['status' => 'error', 'message' => 'Datos JSON inválidos o vacíos.']);
    exit;
}

// --- Aquí procesas los datos ---
// Acceder a los datos (ejemplo si $data es un objeto):
$nombre = isset($data->nombre) ? filter_var(trim($data->nombre), FILTER_SANITIZE_STRING) : null;
$apellido = isset($data->apellido) ? filter_var(trim($data->apellido), FILTER_SANITIZE_STRING) : null;
$telefono = isset($data->telefono) ? filter_var(trim($data->telefono), FILTER_SANITIZE_STRING) : null;
$direccion = isset($data->direccion) ? filter_var(trim($data->direccion), FILTER_SANITIZE_STRING) : null;
$localidad = isset($data->localidad) ? filter_var(trim($data->localidad), FILTER_SANITIZE_STRING) : null;

// Validar que los datos esenciales no estén vacíos después de limpiar
if (empty($nombre) || empty($apellido) || empty($telefono) || empty($direccion) || empty($localidad)) {
     http_response_code(400); // Bad Request
     echo json_encode(['status' => 'error', 'message' => 'Faltan datos requeridos.']);
     exit;
}


// Ejemplo 1: Guardar en un archivo de texto (simple, no ideal para producción)
/*
$fileContent = "Nombre: $nombre\nApellido: $apellido\nTeléfono: $telefono\nDirección: $direccion\nLocalidad: $localidad\n-----------------\n";
file_put_contents('datos_cotizador.txt', $fileContent, FILE_APPEND | LOCK_EX);
*/

// Ejemplo 2: Enviar por correo electrónico (asegúrate que tu hosting permita mail())
/*
$to = "ventas@plakasec.com"; // Tu email
$subject = "Nueva consulta desde Cotizador Web";
$body = "Se recibió una nueva consulta:\n\n";
$body .= "Nombre: $nombre\n";
$body .= "Apellido: $apellido\n";
$body .= "Teléfono: $telefono\n";
$body .= "Dirección: $direccion\n";
$body .= "Localidad: $localidad\n";
$headers = "From: no-reply@tudominio.com"; // Usa un email de tu dominio

mail($to, $subject, $body, $headers);
*/

// --- Fin del procesamiento ---


// Enviar una respuesta JSON de éxito al frontend
http_response_code(200); // OK
echo json_encode([
    'status' => 'success',
    'message' => 'Datos recibidos correctamente.',
    // Puedes incluir aquí algún dato extra si lo necesitas
]);

exit; // Terminar el script

?>
